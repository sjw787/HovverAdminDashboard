SES ACCOUNT MIGRATION GUIDE
===========================
Date: January 17, 2026

ISSUE
-----
SES was accidentally configured in the wrong AWS account:
- Current account: 777653593792 (iamadmin-general)
- Target account: 052869941234 (iamadmin-dev)

The infrastructure (Cognito, S3, ECS) is in iamadmin-dev (052869941234),
so SES must also be in that account for seamless integration.

CURRENT STATUS
--------------
Account 777653593792 (iamadmin-general):
- Has samwylock.com domain configured in SES
- Domain is verified
- DKIM is enabled and verified

Account 052869941234 (iamadmin-dev):
- Needs SES domain configured
- Has Cognito User Pool: us-east-1_vqzmBxIoP
- Has S3 bucket: hovver-images-dev
- Has ECS cluster running the admin dashboard

MIGRATION STEPS
----------------

STEP 1: Delete SES from iamadmin-general account
-------------------------------------------------
Run with credentials for account 777653593792:

  python migrate_ses_account.py

When prompted, type "yes" to confirm deletion.

STEP 2: Switch to iamadmin-dev account
---------------------------------------
You need to use AWS credentials for account 052869941234.

Option A - Using AWS Profile:
  Check if you have a profile configured:
    aws configure list-profiles

  If you have iamadmin-dev profile:
    $env:AWS_PROFILE="iamadmin-dev"  # PowerShell
    export AWS_PROFILE=iamadmin-dev  # Bash

  Or create a new profile:
    aws configure --profile iamadmin-dev
    # Enter access key and secret for iamadmin-dev account

Option B - Using Environment Variables:
  Set these environment variables with credentials for 052869941234:
    $env:AWS_ACCESS_KEY_ID="<your-access-key>"
    $env:AWS_SECRET_ACCESS_KEY="<your-secret-key>"

  # Clear the AWS_PROFILE if set
    Remove-Item Env:AWS_PROFILE

STEP 3: Verify you're in the correct account
---------------------------------------------
  python -c "import boto3; sts = boto3.client('sts'); print('Account:', sts.get_caller_identity()['Account'])"

Expected output: Account: 052869941234

STEP 4: Setup SES in iamadmin-dev account
------------------------------------------
  python migrate_ses_account.py --setup-only

This will:
- Register samwylock.com with SES in iamadmin-dev
- Enable DKIM
- Generate verification tokens

STEP 5: Verify DNS records (no changes needed)
-----------------------------------------------
The DNS records in Route53 (admin-legacy account) are already correct.
The verification token and DKIM tokens from the new SES setup should match
the existing DNS records, OR you may need to update them if they changed.

Check if DNS records need updating:
  .\verify-ses-status.ps1

If the DKIM tokens changed, you'll need to update Route53:
  .\setup_dns.ps1 -Domain "samwylock.com" -Route53

STEP 6: Wait for verification
------------------------------
Wait 5-30 minutes for DNS propagation and SES verification.

Check status:
  python setup_ses.py --check-status samwylock.com

STEP 7: Configure Cognito to use SES
-------------------------------------
Once SES is verified in iamadmin-dev, configure Cognito:

1. Go to AWS Console > Cognito > User Pools
2. Select pool: us-east-1_vqzmBxIoP
3. Go to "Messaging" > "Email"
4. Change from "Cognito defaults" to "Send email with Amazon SES"
5. Set FROM email address: noreply@samwylock.com
6. Save changes

Or use Terraform/AWS CLI to update:
  aws cognito-idp update-user-pool \
    --user-pool-id us-east-1_vqzmBxIoP \
    --email-configuration \
      SourceArn=arn:aws:ses:us-east-1:052869941234:identity/samwylock.com,\
      EmailSendingAccount=DEVELOPER,\
      From=noreply@samwylock.com

VERIFICATION CHECKLIST
----------------------
[ ] SES deleted from account 777653593792
[ ] Switched credentials to account 052869941234
[ ] SES domain registered in account 052869941234
[ ] DKIM enabled in account 052869941234
[ ] DNS records verified in Route53 (admin-legacy)
[ ] Domain verification status: Success
[ ] DKIM verification status: Success
[ ] Cognito configured to use SES
[ ] Test email sent successfully

TROUBLESHOOTING
---------------
Issue: "Already in target account" but wrong account number shows
Solution: Check which credentials are actually being used:
  - Check $env:AWS_ACCESS_KEY_ID and $env:AWS_SECRET_ACCESS_KEY
  - Check $env:AWS_PROFILE
  - Check ~/.aws/credentials file

Issue: DKIM tokens don't match DNS records
Solution: SES generates new DKIM tokens each time you verify a domain.
  If tokens changed, update Route53 with new tokens:
    .\setup_dns.ps1 -Domain "samwylock.com" -Route53

Issue: Verification fails
Solution: Check DNS records in Route53:
  aws route53 list-resource-record-sets \
    --hosted-zone-id Z0463989E6ZRMK2X7OOO \
    --profile admin-legacy \
    --query "ResourceRecordSets[?contains(Name, 'amazonses') || contains(Name, '_domainkey')]"

SCRIPTS AVAILABLE
-----------------
- check_ses_account.py - Check which account has SES configured
- migrate_ses_account.py - Delete from one account and setup in another
- setup_ses.py - Register domain with SES and get tokens
- setup_dns.ps1 - Add DNS records to Route53
- verify-ses-status.ps1 - Check SES verification status

KEY INFRASTRUCTURE INFO
-----------------------
Accounts:
- iamadmin-general: 777653593792 (wrong account, delete SES from here)
- iamadmin-dev: 052869941234 (correct account, setup SES here)
- admin-legacy: (has Route53 hosted zone Z0463989E6ZRMK2X7OOO)

Resources in iamadmin-dev (052869941234):
- Cognito User Pool: us-east-1_vqzmBxIoP
- S3 Bucket: hovver-images-dev
- ECR: 052869941234.dkr.ecr.us-east-1.amazonaws.com/hovver-admin-app
- ECS Cluster: hovver-admin-cluster
- SES: samwylock.com (needs to be here!)

Resources in admin-legacy:
- Route53 Hosted Zone: Z0463989E6ZRMK2X7OOO (samwylock.com)
- ACM Certificate: *.samwylock.com
- DNS Records for SES verification
